---
title: IP：网际协议
date: 2016-04-15 21:03:10
updated: 2016-04-15 21:03:19
categories: [Reading, TCP/IP详解 卷1：协议]
tags: [Protocol]
---

# 前言

提供不可靠、无连接的数据传送服务。

- 不可靠（unreliable）：
    - 不保证IP数据报能成功到达目的地
    - 错误处理方法：丢弃该数据报，然后发送ICMP消息报给信源端
    - 任何要求的可靠性必须由上层来提供（如TCP）
- 无连接（connectionless）：
    - IP不维护任何关于后续数据报的状态信息
    - 每个数据报的处理是相互独立的，可不按发送顺序接口，可独立选择路由

<!-- more -->

# IP首部

## IP数据报格式

![](http://7xjq7c.com1.z0.glb.clouddn.com/RG%5D1H%7B%7BG7IOG443%254KYWME9.png?imageMogr2/thumbnail/450x)

## 首部字段

1. 目前的协议版本号是4。
2. 首部长度是指首部占32bit字的数目，即首部长度为2即表示首占8字节。由于它是4比特字段，因此首部最长为60字节。
3. 服务类型（TOS，type of service)字段：
    1. 3bit的优先权子字段（已被忽略）
    2. 4bit的TOS字段：
        1. 最小时延
        2. 最大吞吐量
        3. 最高可靠性
        4. 最小费用
    3. 1bit的未用位，必须置0
4. 总长度字段指整个IP数据报的长度（单位：字节），该字段长度为16bit，所以数据报最长可达65535Byte。该字段是必要字段，因为一些数据链路需要填充一些数据以达到最小长度，比如以太网的最下帧长为46Byte，IP数据报可能会小于46Byte，此时数据链路会填充不足的部分以达到最小帧长，当接收IP数据报时就需要通过总长度字段识别46字节中多少是IP数据报的内容。
5. 标识字段唯一的标识主机发送的每一个数据报，通过每发一份其值加1。
6. 生存时间（TTL，time to live）设置了数据报可以经过的最多路由器数。
7. 首部校验和是根据IP首部计算的校验和码。ICMP、IGMP、UDP和TCP在它们各自的首部中均含有同时覆盖首部和数据校验和码
    1. 校验和字段置0
    2. 对首部中每个16bit进行二进制反码求和，结果存入校验和字段中
    3. 收到IP数据报后，同样对首部中每个16bit进行反码求和，由于接收方在计算过程中包含了发送方存在首部中的校验和，因此，如果首部在传输过程中没有发送任何差错是，计算结果应该全为1
    4. 由于路由器会修改TTL字段（减1），所以每转发一份报文时，增加它的校验和
8. 任选项（很少被使用）：
    1. 安全和处理限制
    2. 记录路径
    3. 时间戳
    4. 严格的源站选路
    5. 以上为任选项，它们都是以32bit为界限，必要时插入值为0的填充字节，保证IP首部始终是32bit的整数倍

# IP路由选择

- 源主机
    1. 如果目的主机和源主机直接相连（点对点链路）或都在一个共享网络上（以太网或令牌环网），那么数据报被直接送到目的主机上。
    2. 否则主机把数据发送到默认的路由器上。
- 目的主机
    1. 收到一份数据报并进行发送时，它会检索路由表
    2. 当数据报来自某个网络接口时，IP首先检查目的IP地址是否为本机的IP地址之一或者IP广播地址
        1. 如果是，数据报就被送到有IP首部协议字段所指定的协议模块进行处理
        2. 如果不是
            1. 如果IP层被设置为路由器的功能，转发数据报
            2. 否则丢弃数据报


## 路由表

### 字段

- 目的IP地址，可以是完整的主机地址，也可以是网络地址，有标志字段指定。主机地址有一个非0的主机号，以指定某一特定的主机；网络地址的主机号为0，指定网络中的所有主机（如以太网、令牌网）。
- 下一跳路由器（next-hop router）的IP地址，或者有直接连接的网络IP地址。下一跳路由器是指一个直接相连网络上的路由器，通过它转发数据报。
- 标志，其中一个指明目的IP地址是网络地址还是主机地址；另一个指明下一跳路由器是否为真正的下一个路由器，还是一个直接相连的接口。
- 为数据报的传输指定一个网络接口。

### 功能

1. 搜索路由表，寻找能与目的IP地址完全匹配的表目（网络号和主机号都要匹配）。如果找到，则把报文发送给该表目指定的下一跳路由器或直接连接的网络接口（取决于标志字段）
2. 搜索路由表，寻找能与目的网路号相匹配的表目。如果找到，则把报文发送给该表目指定的下一跳路由器或直接连接的网络接口（取决于标志字段）。目的网络上的所有主机都可以通过这个表目来处置。
3. 搜索路由表，寻找默认表目，并把报文发送给默认表目。

如果上面步骤都没成功，那么该数据报就不能被传送。如果不能传送的数据报来自本机，那么会向生成数据报的应用程序返回一个“主机不可达”或“网络不可达”的错误。

为一个网络指定一个路由器，而不必为一个主机指定一个路由器，这样做客极大缩小路由表的规模，比如Internet上的路由器有只有几千个表目，而不会超过100万个。

# 子网寻址

- 子网编址：将主机号分成一个子网号和一个主机号
- 原因：A类和B类地址为主机号分配了太多的空间，而事实中一个网络中并不安排这么多主机。
- 子网对外部路由器来说隐藏了内部网络组织的细节，而对于子网内部的路由器是不透明的。
- 与30个C类地址相比，用一个包含30个子网的B类地址的好处是可以缩小Internet路由表的规模。

# 子网掩码

## 目的和构成

- 确定多少比特用于子网号，多少比特用于主机号。
- 1的比特留给网络号和子网号，0的比特留个主机号。

## 确定IP数据报的目的

1. 本子网的主机
2. 本网络中其它子网中的主机
3. 其它网络上的主机

如果知道本机的IP地址，就可确认其为A类、B类或C类，也就可知网络号和子网号之间的分界线，再根据子网掩码即可确定子网号和主机号之间的分界线。

# 体会

最近在读TCP/IP详解这本书，个人觉得写的很棒，翻译的也很不错，大部分内容都能看懂，难点的就是书中的那些例子，没有办法去实现它，想尝试着测试一下。

# 更新日志

- 2016-04-15 21:03:10 星期五 初稿
- 2016-04-15 21:03:10 星期五 初次发布
